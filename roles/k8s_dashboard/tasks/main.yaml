---
# Traefik â†” Kubernetes Dashboard: ServersTransport + Service/Ingress annotations

# 0) Apply ServersTransport that skips TLS verify for the dashboard Service
- name: Ensure Traefik ServersTransport (insecure) exists
  tags: [dashboard]
  k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: ServersTransport
      metadata:
        name: dashboard-insecure-transport
        namespace: kubernetes-dashboard
      spec:
        insecureSkipVerify: true

# 1) Put the transport on the Service (namespaced cross-provider ref is REQUIRED)
- name: Annotate dashboard Service with ServersTransport + https scheme
  tags: [dashboard]
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: kubernetes-dashboard
        namespace: kubernetes-dashboard
        annotations:
          traefik.ingress.kubernetes.io/service.serverstransport: "kubernetes-dashboard-dashboard-insecure-transport@kubernetescrd"
          traefik.ingress.kubernetes.io/service.serversscheme: "https"

# 2) Ensure/refresh the Ingress with correct entrypoints and host
- name: Apply/patch dashboard Ingress (web + websecure to Service:443)
  tags: [dashboard]
  k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: dashboard
        namespace: kubernetes-dashboard
        annotations:
          traefik.ingress.kubernetes.io/router.entrypoints: "web,websecure"
          traefik.ingress.kubernetes.io/service.serversscheme: "https"
          traefik.ingress.kubernetes.io/router.tls: "true"
      spec:
        ingressClassName: traefik
        rules:
          - host: "{{ dashboard_host | default('k3-dashboard.' + cloudflare_domain) }}"
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: kubernetes-dashboard
                      port:
                        number: 443
